#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

function indent() {
  c='s/^/       /'
  case $(uname) in
    Darwin) sed -l "$c";;
    *)      sed -u "$c";;
  esac
}

install_r_package() {
  package_url="$1"
  echo "Installing package from $package_url" | indent
  rm package.tar.gz &> /dev/null
  curl $package_url -s -o package.tar.gz &> /dev/null
  /app/vendor/R/bin/R CMD INSTALL ./package.tar.gz 2>&1 | indent

  if [ "${PIPESTATUS[*]}" != "0 0" ]; then
    echo " !     Failed to install $package_url package"
    exit 1
  fi
}

# parse and derive params
BUILD_DIR=$1
CACHE_DIR=$2
LP_DIR=`cd $(dirname $0); cd ..; pwd`

# config
R_VERSION="2.15.1"
S3_BUCKET="heroku-buildpack-r"
R_BINARIES="http://${S3_BUCKET}.s3.amazonaws.com/R-${R_VERSION}-binaries.tar.gz"
VENDOR_DIR="$BUILD_DIR/vendor"
R_HOME="$VENDOR_DIR/R"

# vendor R into the slug
echo "Vendoring R $R_VERSION" | indent

# download and unpack binaries
mkdir -p $VENDOR_DIR && curl $R_BINARIES -s -o - | tar xzf - -C $VENDOR_DIR
cp -R $VENDOR_DIR/* /app/vendor

# install dependencies from CRAN
echo "Installing dependencies from CRAN" | indent

# R needs to know where gfortran and glibc header files are
export PATH=/app/vendor/gcc-4.3/bin:$PATH
export LDFLAGS="-L/app/vendor/gcc-4.3/lib64/ -R/app/vendor/gcc-4.3/lib64/"
export CPPFLAGS="-I/app/vendor/glibc-2.7/string/ -I/app/vendor/glibc-2.7/time"

while read line
do
  package_url=`echo $line | sed -n '/^[^#]/p'`
  if [ $package_url ]; then
    install_r_package $package_url
  fi
done < $BUILD_DIR/r_packages

echo "Dependencies installed" | indent
